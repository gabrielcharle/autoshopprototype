<%# singleDashboard.ejs (FINAL CORRECTED VERSION FOR CHART RENDERING) %>

<h2>Visualization Area for <%= title %></h2>

<% 
// Helper function to generate distinct colors for charts
// This must remain here in EJS scope for use in the JS function below
const generateColors = (count) => {
    const colors = [];
    const baseColors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'];
    for(let i = 0; i < count; i++) {
        const hue = i * (360 / count);
        colors.push(baseColors[i % baseColors.length] || `hsl(${hue}, 70%, 50%)`); 
    }
    return colors;
}
%>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script id="dashboard-data" type="application/json">
{
    "dashboardNumber": <%= dashboardNumber %>,
    "data": <%- JSON.stringify(data) %>
}
</script>

<% if (dashboardNumber === 6) { %>
    <h3>üìç Stock Breakdown by Location</h3>
    
    <% 
        if (Array.isArray(data) && data.length > 0) {
            const locationLabels = data.map(loc => loc.locationID); 
            let locationQuantities = data.map(loc => loc.totalQuantity);
            let totalQty = locationQuantities.reduce((a, b) => a + b, 0);
    %>

    <div style="display: flex; gap: 30px; margin-bottom: 30px;">
        <div style="flex: 2;">
            <h4>Inventory Quantity by Location </h4>
            <canvas id="locationPieChart" width="400" height="200"></canvas>
        </div>
        
        <div style="flex: 3;">
            <p>Total Items Across All Locations: **<%= totalQty %>**</p>
            <table border="1" cellpadding="8" cellspacing="0" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #e9ecef;">
                        <th style="width: 30%;">Location</th>
                        <th style="width: 50%;"># of Unique Items</th>
                        <th style="width: 20%;">Total Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    <% data.forEach((locationObj) => { %> 
                        <tr>
                            <td><%= locationObj.locationID %></td> 
                            <td><%= locationObj.items.length %></td> 
                            <td><%= locationObj.totalQuantity %></td> 
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
    
    <% } else { %>
        <p>No inventory records found across multiple locations to generate a breakdown report.</p>
    <% } %>

<% } else if (dashboardNumber === 5) { %>
    <h3>‚≠ê Vendor Performance and Value Share</h3>

    <% 
        if (Array.isArray(data) && data.length > 0) {
            const vendors = data; 
    %>

    <div style="display: flex; gap: 30px; margin-bottom: 30px;">
        <div style="flex: 2;">
            <h4>Vendor Value Share </h4>
            <canvas id="vendorPieChart" width="400" height="200"></canvas>
        </div>
        
        <div style="flex: 3;">
            <h4>Performance Summary Table</h4>
            <table border="1" cellpadding="10" cellspacing="0" style="width: 100%;">
                <thead>
                    <tr style="background-color: #f0f8ff;">
                        <th>Vendor Name</th>
                        <th>Total Value Received</th>
                        <th>Total Items Received</th>
                        <th># of Receipts</th>
                    </tr>
                </thead>
                <tbody>
                    <% vendors.forEach(vendor => { %>
                        <tr>
                            <td><%= vendor.vendorName %></td> 
                            <td style="font-weight: bold;">$<%= vendor.totalValue %></td> 
                            <td><%= vendor.totalQuantity %></td> 
                            <td><%= vendor.receiptCount %></td> 
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <% } else { %>
        <p>No successful 'RECEIVE' transactions found to generate vendor performance metrics.</p>
    <% } %>

<% } else if (dashboardNumber === 4) { %>
    <h3>üîÑ Inventory Turns and Aged Stock</h3>

    <div style="display: flex; gap: 30px; margin-bottom: 30px;">
        <div style="flex: 1; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9;">
            <h4>Inventory Turns Score</h4>
            <h1 style="color: #2e8b57; font-size: 3em; margin: 0;"><%= data.inventoryTurns %></h1>
            <p style="font-size: 0.9em; color: #555;">(COGS / Avg. Inventory - Annualized)</p>
            <p>Calculations based on:</p>
            <ul>
                <li>Simulated COGS (Issued Cost last 30 days): **$<%= data.totalIssuedCost %>**</li>
                <li>Current Inventory Value: **$<%= data.currentInventoryValue %>**</li>
            </ul>
        </div>
        
        <div style="flex: 1;">
            <h4>Inventory Turns Visualization </h4>
            <canvas id="inventoryTurnsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <h4>üï∞Ô∏è Aged Stock (Received > 90 days ago)</h4>
    <% if (data.agedStockList && data.agedStockList.length > 0) { %>
        <table border="1" cellpadding="10" cellspacing="0" style="width: 100%;">
            <thead>
                <tr style="background-color: #ffcccc;">
                    <th>SKU</th>
                    <th>Part Name</th>
                    <th>Quantity</th>
                    <th>Date Received</th>
                </tr>
            </thead>
            <tbody>
                <% data.agedStockList.forEach(item => { %>
                    <tr>
                        <td><%= item.sku %></td>
                        <td><%= item.partName %></td>
                        <td><%= item.quantity %></td>
                        <td><%= item.dateReceived %></td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } else { %>
        <p style="color: green; font-weight: bold;">‚úÖ No aged stock found! Everything is fresh.</p>
    <% } %>

<% } else if (dashboardNumber === 3) { %>
    <h3>üïí Transaction History Log</h3>
    
    <% 
        if (Array.isArray(data) && data.length > 0) { 
        // Data aggregation for rendering the table and the chart
    %>

    <div style="display: flex; gap: 30px; margin-bottom: 30px;">
        <div style="flex: 2;">
            <h4>Transaction Volume Trend (Last 10 Days) </h4>
            <canvas id="transactionTrendChart" width="400" height="200"></canvas>
            
        </div>
        <div style="flex: 3;">
            <table border="1" cellpadding="10" cellspacing="0" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>SKU</th>
                        <th>Transaction Type</th>
                        <th>Qty Change</th>
                    </tr>
                </thead>
                <tbody>
                    <% data.forEach(item => { %>
                        <tr style="background-color: <%= item.model === 'RECEIVE' ? '#e6ffe6' : '#fff0f0' %>;">
                            <td><%= item.timestamp %></td>
                            <td><%= item.sku %></td>
                            <td><%= item.model %></td>
                            <td style="font-weight: bold; color: <%= item.model === 'RECEIVE' ? 'green' : 'red' %>;"><%= item.quantityChange %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
    
    <% } else { %>
        <p>No transaction history entries found.</p>
    <% } %>

<% } else if (dashboardNumber === 2) { %>
    <h3>üî¥ Critical Stock List</h3>
    
    <% 
        const isArrayOfItems = Array.isArray(data);
        const lowStockCount = isArrayOfItems ? data.length : 0;
        const totalItemsInInventory = 52; // Based on Stock Overview log
        const healthyStockCount = totalItemsInInventory - lowStockCount; 
    %>
    
    <div style="display: flex; gap: 30px; margin-bottom: 30px;">
        <div style="flex: 2;">
            <h4>Stock Health Breakdown </h4>
            <canvas id="stockHealthChart" width="400" height="200"></canvas>
        </div>
        <div style="flex: 3;">
            <table border="1" cellpadding="10" cellspacing="0" style="width: 100%;">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Part Name</th>
                        <th>Current Quantity</th>
                        <th>Reorder Point</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (isArrayOfItems) { %>
                        <% data.forEach(item => { %>
                            <tr style="color: <%= item.quantity <= item.reorderPoint ? 'red' : 'inherit' %>;">
                                <td><%= item.sku %></td>
                                <td><%= item.partName %></td>
                                <td><%= item.quantity %></td>
                                <td><%= item.reorderPoint %></td>
                                <td><%= item.location %></td>
                            </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
            <% if (!isArrayOfItems || data.length === 0) { %>
                <p style="color: green; font-weight: bold;">‚úÖ All inventory levels are currently OK!</p>
            <% } %>
        </div>
    </div>

<% } else if (dashboardNumber === 1) { %>
    <h3>üìà Current Stock Overview (Quantity and Value)</h3>
    
    <% 
        if (data && data.items && Array.isArray(data.items) && data.items.length > 0) { 
            const inventoryItems = data.items;
            const grandTotalValue = data.grandTotalValue;
    %>
    <div style="display: flex; gap: 30px; margin-bottom: 30px;">
        <div style="flex: 2;">
            <h4>Top 5 Items by Total Value </h4>
            <canvas id="top5ValueChart" width="400" height="200"></canvas>
        </div>
        <div style="flex: 3;">
            <table border="1" cellpadding="10" cellspacing="0" style="width: 100%;">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Part Name</th>
                        <th>Current Quantity</th>
                        <th>Unit Cost</th>
                        <th>Total Value</th>
                    </tr>
                </thead>
                <tbody>
                    <% inventoryItems.forEach(item => { %> 
                        <tr>
                            <td><%= item.sku %></td>
                            <td><%= item.partName %></td>
                            <td><%= item.quantity %></td>
                            <td>$<%= item.unitCost %></td>
                            <td style="font-weight: bold;">$<%= item.totalValue %></td>
                        </tr>
                    <% }); %>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: bold;">GRAND TOTAL INVENTORY VALUE:</td>
                        <td style="font-weight: bold; background-color: #e9ecef;">$<%= grandTotalValue %></td> 
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <% } else { %>
        <p>No inventory records found.</p>
    <% } %>

<% } else { %>
    <p>All six primary dashboards have been implemented.</p>
<% } %>


<%# ---------------------------------------------------- %>
<%# üåü CHART INITIALIZATION SCRIPT (THE FIX) üåü %>
<%# ---------------------------------------------------- %>

<script>
    function initializeCharts() {
        // Retrieve dynamic data and dashboard number
        const dashboardDataElement = document.getElementById('dashboard-data');
        if (!dashboardDataElement) return;

        const { dashboardNumber, data: rawData } = JSON.parse(dashboardDataElement.textContent);
        
        // Helper to generate colors (Re-defined for JS scope since EJS helper isn't natively accessible)
        const generateColors = (count) => {
            const colors = [];
            const baseColors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2'];
            for(let i = 0; i < count; i++) {
                // Simplified color logic, using the same base colors
                colors.push(baseColors[i % baseColors.length] || `hsl(${i * (360 / count)}, 70%, 50%)`); 
            }
            return colors;
        }

        if (dashboardNumber === 6) {
            // Location Breakdown (Pie Chart)
            const ctx = document.getElementById('locationPieChart');
            if (ctx && Array.isArray(rawData) && rawData.length > 0) {
                const labels = rawData.map(loc => loc.locationID);
                const values = rawData.map(loc => loc.totalQuantity);
                
                new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: generateColors(labels.length),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Quantity Distribution by Location' }
                        }
                    }
                });
            }
        } else if (dashboardNumber === 5) {
            // Vendor Performance (Pie Chart)
            const ctx = document.getElementById('vendorPieChart');
            if (ctx && Array.isArray(rawData) && rawData.length > 0) {
                const labels = rawData.map(v => v.vendorName);
                const values = rawData.map(v => parseFloat(v.totalValue));
                
                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Value Received ($)',
                        data: values,
                        backgroundColor: generateColors(labels.length),
                        hoverOffset: 10
                    }]
                };

                new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Percentage of Total Inventory Value by Vendor' }
                        }
                    }
                });
            }
        } else if (dashboardNumber === 4) {
            // Inventory Turns (Bar Chart)
            const ctx = document.getElementById('inventoryTurnsChart');
            if (ctx && rawData && rawData.inventoryTurns !== undefined) {
                const turnsScore = rawData.inventoryTurns;
                
                const chartData = {
                    labels: ['Your Score', 'Target Score (4.0)'],
                    datasets: [{
                        label: 'Inventory Turns',
                        data: [turnsScore, 4.0], 
                        backgroundColor: [
                            turnsScore >= 4.0 ? 'rgba(46, 139, 87, 0.8)' : 'rgba(255, 99, 132, 0.8)', 
                            'rgba(54, 162, 235, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 255, 255, 1)',
                            'rgba(255, 255, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                };

                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Turns Score' }
                            }
                        }
                    }
                });
            }
        } else if (dashboardNumber === 3) {
            // Transaction Trend (Line Chart)
            const ctx = document.getElementById('transactionTrendChart');
            if (ctx && Array.isArray(rawData) && rawData.length > 0) {
                // Recalculate/extract needed data 
                const dates = [...new Set(rawData.map(item => item.timestamp.split('T')[0]))].sort().slice(-10);
                const receiveData = dates.map(date => rawData.filter(item => item.timestamp.includes(date) && item.model === 'RECEIVE').reduce((sum, item) => sum + item.quantityChange, 0));
                const issueData = dates.map(date => rawData.filter(item => item.timestamp.includes(date) && item.model === 'ISSUE').reduce((sum, item) => sum + Math.abs(item.quantityChange), 0));

                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Received Quantity',
                                data: receiveData,
                                borderColor: 'rgba(40, 167, 69, 1)',
                                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                fill: true,
                            },
                            {
                                label: 'Issued Quantity',
                                data: issueData,
                                borderColor: 'rgba(220, 53, 69, 1)',
                                backgroundColor: 'rgba(220, 53, 69, 0.2)',
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Quantity' } },
                            x: { title: { display: true, text: 'Date' } }
                        }
                    }
                });
            }
        } else if (dashboardNumber === 2) {
            // Stock Health (Doughnut Chart)
            const ctx = document.getElementById('stockHealthChart');
            if (ctx) {
                const lowCount = Array.isArray(rawData) ? rawData.length : 0;
                const healthyCount = 52 - lowCount; // Total items is 52 based on log
                
                new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Critical Stock', 'Healthy Stock'],
                        datasets: [{
                            data: [lowCount, healthyCount > 0 ? healthyCount : 0],
                            backgroundColor: ['#dc3545', '#28a745'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Inventory Stock Health' }
                        }
                    }
                });
            }
        } else if (dashboardNumber === 1) {
            // Stock Overview (Bar Chart - Top 5)
            const ctx = document.getElementById('top5ValueChart');
            if (ctx && rawData && rawData.items && rawData.items.length > 0) {
                const inventoryItems = rawData.items;

                // Recalculate top 5 logic from raw data in JS
                const top5 = inventoryItems.sort((a, b) => parseFloat(b.totalValue) - parseFloat(a.totalValue)).slice(0, 5);
                const labels = top5.map(item => item.sku);
                const values = top5.map(item => parseFloat(item.totalValue));
                
                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Value ($)',
                            data: values,
                            backgroundColor: generateColors(5),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Inventory Value ($)' } },
                            x: { title: { display: true, text: 'SKU' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
    }

    // üåü FIX: Use a timeout to ensure Chart.js library is loaded AND the canvas elements 
    // for the *current* dashboardNumber are fully rendered and visible in the DOM.
    // The DOMContentLoaded event sometimes fires too early in dynamic rendering.
    window.addEventListener('load', () => {
        // A slight delay is a common way to deal with dynamic loading issues
        setTimeout(initializeCharts, 50); 
    });
</script>